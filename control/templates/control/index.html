{% extends 'control/base.html' %}
{% load static %}


{% block stylesheet %}
    <link rel="stylesheet" type="text/css" href="{% static 'control/css/index.css' %}">
{% endblock %}

{% block javascript %}
    <script src="{% static 'control/yoannmoinet-nipplejs/dist/nipplejs.min.js' %}"></script>
{% endblock %}


{% block content %}

    <!-- The Modal -->
    <div id="waitModal" class="modal">
        <!-- Modal content -->
        <div class="modal-content">
        </div>
    </div>

    <div id="btn-section">
        <button type="button" class="btn btn-success" id="start">Start</button>
        <button type="button" class="btn btn-danger" id="stop">Stop</button>
    </div>

    {#  handle the joysticks  #}
    <div id="jLeft" class="zone"></div>
    <div id="jRight" class="zone"></div>

    

    <section id="data-section">
	    <div style="text-align:center; width:100%;">
	    <center><div class="slidecontainer" style="width:70%;">
	    <input type="range" min="0" max="4" value="0" class="slider" id="modeSlider">
    </div></center>
    </div>
    <br><br>
<div style="text-align:center; width:100%;">
	    <center><div class="slidecontainer" style="width:70%;">
	    <input type="range" min="0" max="1" value="0" class="slider" id="returnHomeSlider">
    </div></center>
    </div>
    <br><br><br>
        <section id="left-joystick">
            <h1 id="left">Left</h1>
            <strong>dx: </strong>
            <div id="dx-lj"></div>

            <strong>dy: </strong>
            <div id="dy-lj"></div>
        </section>

        <section id="right-joystick">
            <h1 id="right">Right</h1>
            <strong>dx: </strong>
            <div id="dx-rj"></div>

            <strong>dy: </strong>
            <div id="dy-rj"></div>
        </section>
    </section>
    <script>
let globalRoll = 0;
let globalPitch = 0;
let globalThrottle = 0;
let globalYaw = 0;

function throttleFunction(func, wait) {
            var timeout;
            return function () {
                var context = this, args = arguments;
                if (!timeout) {
                    // the first time the event fires, we setup a timer, which
                    // is used as a guard to block subsequent calls; once the
                    // timer's handler fires, we reset it and create a new one
                    timeout = setTimeout(function () {
                        timeout = null;
                        func.apply(context, args);
                    }, wait);
                }
            }
        }

        function sleep(milliseconds) {
            let start = new Date().getTime();
            for (let i = 0; i < 1e7; i++) {
                if ((new Date().getTime() - start) > milliseconds) {
                    break;
                }
            }
        }

        function ajax_command(command) {
            $.ajax({
                type: "GET",
                url: 'send_command/',
                data: {
                    'command': command
                },
                dataType: 'json',
                success: function (data) {
                    if (!data.success) {
                        alert("Error communication")
                    }
                }
            });
            //sleep(10);
            {# 10 milliseconds = 0.01 seconds #}
            return false
        }

        let initialized_drone = false;

        $("#start").click(function () {
            ajax_command("start");
            if (!initialized_drone) {
                let modal = document.getElementById('waitModal');
                modal.children[0].innerHTML = "Arm: wait 3 seconds...";
                modal.style.display = "block";

                setTimeout(function () {
                    modal.style.display = "none";
                }, 3000);

            }
            initialized_drone = true;
        });

        $("#stop").click(function () {
            ajax_command("stop");
            if (initialized_drone) {
                let modal = document.getElementById('waitModal');
                modal.children[0].innerHTML = "Disarm: wait 3 seconds...";
                modal.style.display = "block";

                setTimeout(function () {
                    modal.style.display = "none";
                }, 3000);
            }
            initialized_drone = false;
        });

        {#  responsive size of joystick  #}
        let width = window.innerWidth;
        let R = parseInt(width) / 4;

        let joystickLeft = nipplejs.create({
            zone: document.getElementById("jLeft"),
            mode: "static",
            size: R,
            position: {left: '20%', top: '60%'},
            color: "red"
        }); // id = 0

        let joystickRight = nipplejs.create({
            zone: document.getElementById("jRight"),
            mode: "static",
            size: R,
            position: {left: '80%', top: '60%'},
            color: "blue"
        }); // id = 1

        let current_yaw, current_throttle, current_roll, current_pitch = 0;

        {# left joystick: x-axis = yaw; y-axis = throttle #}
        {# right joystick: x-axis = roll; y-axis = pitch #}

        function joystick_yaw_percentage() {
            let yaw = ($('#dx-lj').text() / 2);
            if (yaw === current_yaw) {
                yaw = -1;
            } else {
                current_yaw = yaw;
            }
            return yaw;
        }

        function joystick_throttle_percentage() {
            let throttle = ($('#dy-lj').text() / 2);
            if (throttle === current_throttle) {
                throttle = -1;
            } else {
                current_throttle = throttle;
            }
            return throttle;
        }

        function joystick_roll_percentage() {
            let roll = ($('#dx-rj').text() / 2);
            if (roll === current_roll) {
                roll = -1;
            } else {
                current_roll = roll;
            }
            return roll;
        }

        function joystick_pitch_percentage() {
            let pitch = ($('#dy-rj').text() / 2);
            if (pitch === current_pitch) {
                pitch = -1;
            } else {
                current_pitch = pitch;
            }
            return pitch;
        }

let thrInterval = 250;
let rollThr = throttleFunction(function() {ajax_command("attitude_roll_" + globalRoll);},thrInterval);
let pitchThr = throttleFunction(function() {ajax_command("attitude_pitch_" + globalPitch);},thrInterval);
let yawThr = throttleFunction(function() {ajax_command("attitude_yaw_" + globalYaw);},thrInterval);
let throttleThr = throttleFunction(function() {ajax_command("attitude_throttle_" + globalThrottle);},thrInterval);


$("#modeSlider").slider({
	 slide: function (event, ui) {
	 }
 });
$("#modeSlider").on("input", throttleFunction(function (event, ui) {
	var number = $(this).val();
        var command = "mode_" + number;
        console.log(command);
        //send_ajax_command(command);
        ajax_command(command);
}, thrInterval));
 
             $("#modeSlider").on("change", function (event, ui) {
                 var number = $(this).val();
                 var command = "mode_" + number;
                 console.log(command);
                 //send_ajax_command(command);
                 ajax_command(command);
             });


$("#returnHomeSlider").slider({
	 slide: function (event, ui) {
	 }
 });
$("#returnHomeSlider").on("input", throttleFunction(function (event, ui) {
	var number = $(this).val();
        var command = "return-home_" + number;
        console.log(command);
        //send_ajax_command(command);
        ajax_command(command);
}, thrInterval));
 
             $("#returnHomeSlider").on("change", function (event, ui) {
                 var number = $(this).val();
                 var command = "retuen-home_" + number;
                 console.log(command);
                 //send_ajax_command(command);
                 ajax_command(command);
             });




        {# events types are end and move #}
        {#  values are between 0-200  #}
        joystickLeft.on('move', function (event, data) {

            {#console.log(event);#}
            {#console.log(data);#}

            $('#dx-lj').html((parseInt(Math.cos(data.angle.radian) * (data.distance*202/R) + 100)));
            $('#dy-lj').html((parseInt(Math.sin(data.angle.radian) * (data.distance*202/R) + 100)));
            let yaw = joystick_yaw_percentage();
            let throttle = joystick_throttle_percentage();
            if (initialized_drone) {
                if (yaw >= 0) {
			globalYaw = yaw;
                        yawThr.apply(null, null);
                }
                if (throttle >= 0) {
			globalThrottle = throttle;
                        throttleThr.apply(null, null);
                }
            }
        });

        joystickLeft.on('end', function () {
            $('#dx-lj').html(100);
            $('#dy-lj').html(0);
            let yaw = joystick_yaw_percentage();
            let throttle = joystick_throttle_percentage();
            if (initialized_drone) {
                if (yaw >= 0) {
                    ajax_command("attitude_yaw_" + yaw);
                }
                if (throttle >= 0) {
                    ajax_command("attitude_throttle_" + throttle);
                }
            }
        });




        joystickRight.on('move', function (event, data) {

            {#console.log(event);#}
            {#console.log(data);#}

            
	    $('#dx-rj').html((parseInt(Math.cos(data.angle.radian) * (data.distance*202/R) + 100)));
            $('#dy-rj').html((parseInt(Math.sin(data.angle.radian) * (data.distance*202/R) + 100)));
            let roll = joystick_roll_percentage();
            let pitch = joystick_pitch_percentage();
            if (initialized_drone) {
                if (roll >= 0) {
			globalRoll = roll;
			rollThr.apply(null, null);
                }
                if (pitch >= 0) {
			globalPitch = pitch;
                        pitchThr.apply(null, null);
                }
            }
        });

        joystickRight.on('end', function () {
            $('#dx-rj').html(100);
            $('#dy-rj').html(100);
            let roll = joystick_roll_percentage();
            let pitch = joystick_pitch_percentage();
            if (initialized_drone) {
                if (roll >= 0) {
                    ajax_command("attitude_roll_" + roll);
                }
                if (pitch >= 0) {
                    ajax_command("attitude_pitch_" + pitch);
                }
            }
        });

    </script>

{% endblock %}
